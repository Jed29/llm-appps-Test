<!DOCTYPE html>
<html>
<head>
    <title>LLM Maps - Quick Test</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; }
        .google-map { height: 400px; width: 100%; border-radius: 8px; }
    </style>
    <!-- Google Maps will be loaded dynamically -->
</head>
<body>
    <h1>üß™ LLM Maps - Quick Test</h1>
    
    <div id="status" class="status offline">Checking...</div>
    
    <h3>Test Backend:</h3>
    <button onclick="testHealth()">Test Health</button>
    <button onclick="testChat()">Test Chat</button>
    
    <h3>Test Ollama:</h3>
    <button onclick="testOllama()">Test Ollama</button>
    
    <h3>Test Maps Integration:</h3>
    <button onclick="testMaps()">üó∫Ô∏è Test Location Search</button>
    <button onclick="testFullChat()">ü§ñ Test LLM + Maps</button>
    <button onclick="testCustomQuery()">üí¨ Custom Query Test</button>
    <p style="font-size: 12px; color: #666;">No Google API key needed for basic testing!</p>
    
    <div id="results"></div>
    <div id="mapContainer" style="margin-top: 20px;"></div>

    <script>
        async function testHealth() {
            const results = document.getElementById('results');
            try {
                const response = await fetch('http://localhost:3000/api/health');
                const data = await response.json();
                results.innerHTML = '<h4>‚úÖ Health Check:</h4><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                document.getElementById('status').className = 'status online';
                document.getElementById('status').innerHTML = 'üü¢ Backend Online';
            } catch (error) {
                results.innerHTML = '<h4>‚ùå Health Check Failed:</h4><p>' + error.message + '</p>';
                document.getElementById('status').className = 'status offline';
                document.getElementById('status').innerHTML = 'üî¥ Backend Offline';
            }
        }

        async function testChat() {
            const results = document.getElementById('results');
            try {
                const response = await fetch('http://localhost:3000/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'Hello, test message' })
                });
                const data = await response.json();
                results.innerHTML = '<h4>üí¨ Chat Test:</h4><pre>' + JSON.stringify(data, null, 2) + '</pre>';
            } catch (error) {
                results.innerHTML = '<h4>‚ùå Chat Test Failed:</h4><p>' + error.message + '</p>';
            }
        }

        async function testMaps() {
            window.open('https://www.google.com/maps/search/restaurants+near+me', '_blank');
        }

        async function testFullChat() {
            const results = document.getElementById('results');
            const mapContainer = document.getElementById('mapContainer');
            
            results.innerHTML = '<h4>‚è≥ Testing LLM + Maps...</h4>';
            mapContainer.innerHTML = '';
            
            try {
                const response = await fetch('http://localhost:3000/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'cari restoran pizza terdekat' })
                });
                const data = await response.json();
                
                results.innerHTML = '<h4>üó∫Ô∏è LLM + Maps Test Results:</h4>' +
                    '<p><strong>‚úÖ LLM Reply:</strong> ' + data.reply + '</p>' +
                    '<details><summary>üìã Full Response Data</summary><pre>' + JSON.stringify(data, null, 2) + '</pre></details>';
                
                if (data.mapData) {
                    mapContainer.innerHTML = 
                        '<div style="border: 2px solid #4CAF50; padding: 15px; border-radius: 10px; background: #f9fff9;">' +
                        '<h4>üéØ Map Integration Success!</h4>' +
                        '<p><strong>üîç Search Query:</strong> ' + data.mapData.searchQuery + '</p>' +
                        '<div style="margin: 15px 0;">' +
                        '<div id="map-' + Date.now() + '" style="height: 400px; border-radius: 8px; border: 1px solid #ddd;"></div>' +
                        '<script>' +
                        'if (typeof google !== "undefined") {' +
                        '  initMap("' + data.mapData.searchQuery + '", "map-' + Date.now() + '");' +
                        '} else {' +
                        '  document.getElementById("map-' + Date.now() + '").innerHTML = ' +
                        '    "<div style=\\"padding:20px;text-align:center;background:#f5f5f5;\\">üó∫Ô∏è Loading Google Maps...</div>";' +
                        '}' +
                        '</script>' +
                        '</div>' +
                        '<a href="' + data.mapData.mapUrl + '" target="_blank" style="background: #4CAF50; color: white; padding: 12px 20px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold;">üó∫Ô∏è Open in Full Google Maps</a>' +
                        '</div>';
                } else {
                    mapContainer.innerHTML = '<div style="border: 2px solid #f44336; padding: 15px; border-radius: 10px; background: #fff9f9;"><p>‚ùå No location data detected in LLM response</p></div>';
                }
                
            } catch (error) {
                results.innerHTML = '<h4>‚ùå Test Failed:</h4><p>' + error.message + '</p>';
                mapContainer.innerHTML = '<p>‚ùå Check if backend server is running</p>';
            }
        }

        async function testCustomQuery() {
            const query = prompt('Enter location query:', 'cari rumah sakit terdekat');
            if (!query) return;
            
            const results = document.getElementById('results');
            const mapContainer = document.getElementById('mapContainer');
            
            results.innerHTML = '<h4>‚è≥ Testing: "' + query + '"</h4>';
            
            try {
                const response = await fetch('http://localhost:3000/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: query })
                });
                const data = await response.json();
                
                results.innerHTML = '<h4>üó∫Ô∏è Custom Query Results:</h4>' +
                    '<p><strong>Query:</strong> ' + query + '</p>' +
                    '<p><strong>LLM Reply:</strong> ' + data.reply + '</p>';
                
                if (data.mapData) {
                    mapContainer.innerHTML = 
                        '<div style="border: 2px solid #4CAF50; padding: 15px; border-radius: 10px;">' +
                        '<h4>üéØ Generated Map!</h4>' +
                        '<p><strong>Search:</strong> ' + data.mapData.searchQuery + '</p>' +
                        '<a href="' + data.mapData.mapUrl + '" target="_blank" style="background: #4CAF50; color: white; padding: 12px 20px; text-decoration: none; border-radius: 8px;">üó∫Ô∏è Open Maps</a>' +
                        '</div>';
                } else {
                    mapContainer.innerHTML = '<p>‚ùå No location detected</p>';
                }
                
            } catch (error) {
                results.innerHTML = '<h4>‚ùå Error:</h4><p>' + error.message + '</p>';
            }
        }

        async function testOllama() {
            const results = document.getElementById('results');
            try {
                const response = await fetch('http://localhost:11434/api/tags');
                const data = await response.json();
                results.innerHTML = '<h4>ü§ñ Ollama Models:</h4><pre>' + JSON.stringify(data, null, 2) + '</pre>';
            } catch (error) {
                results.innerHTML = '<h4>‚ùå Ollama Test Failed:</h4><p>' + error.message + '</p>';
            }
        }

        // Google Maps integration
        function initMap(searchQuery, mapElementId) {
            const map = new google.maps.Map(document.getElementById(mapElementId), {
                zoom: 13,
                center: { lat: -6.2088, lng: 106.8456 } // Default to Jakarta
            });

            const service = new google.maps.places.PlacesService(map);
            const request = {
                query: searchQuery,
                fields: ['name', 'geometry', 'formatted_address', 'rating'],
            };

            service.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    // Center map on first result
                    map.setCenter(results[0].geometry.location);
                    
                    // Add markers for results
                    results.slice(0, 10).forEach((place, index) => {
                        new google.maps.Marker({
                            position: place.geometry.location,
                            map: map,
                            title: place.name,
                            label: String(index + 1)
                        });
                    });
                }
            });
        }

        // Load Google Maps API dynamically with API key from backend
        async function loadGoogleMaps() {
            try {
                const response = await fetch('/api/maps-config');
                const config = await response.json();
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${config.apiKey}&libraries=places`;
                script.defer = true;
                document.head.appendChild(script);
                
                console.log('‚úÖ Google Maps API loaded securely!');
            } catch (error) {
                console.error('‚ùå Failed to load Google Maps:', error);
            }
        }

        // Auto test on load
        loadGoogleMaps();
        testHealth();
    </script>
</body>
</html>